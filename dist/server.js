"use strict";
var express = require('express');
var path = require('path');
var port = process.env.PORT || 3000;
var app = express();
var bodyParser = require('body-parser');
var mongoose = require('mongoose');
var jwt = require('express-jwt');
var cors = require('cors');
var router = express.Router();
var multer = require("multer");
var Apartment = require('./models/apartment');
var BusinessUnit = require('./models/businessunit');
var Task = require('./models/task');
app.use('/app', express.static(path.resolve(__dirname, 'app')));
app.use('/libs', express.static(path.resolve(__dirname, 'libs')));
app.use(cors());
app.use(bodyParser.urlencoded({ extended: true }));
app.use(bodyParser.json());
app.use(function (req, res, next) {
    res.header("Access-Control-Allow-Origin", "*");
    res.header("Access-Control-Allow-Headers", "Origin, X-Requested-With, Content-Type, Accept");
    next();
});
app.post("/upload", multer({ dest: "./uploads/" }).array("uploads[]", 12), function (req, res) {
    //(res.send(req['files'])); 
    (res.send(req.files));
});
var dbstring = process.env.MONGOLAB_URI ||
    process.env.MONGOHQ_URL ||
    'mongodb://heroku_d4n6hnhl:q4rfc1uikd51d5sups9mipivnl@ds057254.mlab.com:57254/heroku_d4n6hnhl';
var server = app.listen(port, function () {
    var host = server.address().address;
    var port = server.address().port;
    console.log('This express app is listening on port:' + port);
});
var authCheck = jwt({
    secret: new Buffer('460DPY7Pi4xnRUiirPuEfBdxS4wzQGcx8rlA-Qw76fURkmiwtrhv_IXffzsI84HM', 'base64'),
    audience: '1mvHGykVHvxzpwstp2wTmrzLrpzouVTm'
});
mongoose.connect(dbstring, function (err, res) {
    if (err) {
        console.log('ERROR connecting to: ' + dbstring + '. ' + err);
    }
    else {
        console.log('Successfully connected to: ' + dbstring);
    }
    ;
});
router.get('/app/*', function (req, res) {
    res.sendFile(path.resolve(__dirname, 'index.html'));
});
router.get('/api', authCheck, function (req, res) {
    res.json({ message: 'hooray! welcome to our api!' });
});
router.route('/api/getusers')
    .get(function (req, res) {
    Apartment.find({ userEmail: { $exists: true, $ne: null } }, 'userEmail', function (err, apartments) {
        if (err)
            res.send(err);
        res.json(apartments);
    });
});
router.route('/api/apartments/updateprofile/:_id')
    .put(function (req, res) {
    Apartment.findById(req.params._id, function (err, apartment) {
        if (err)
            res.send(err);
        apartment.userFirstName = req.body.userFirstName;
        apartment.save(function (err) {
            if (err)
                res.send(err);
            res.json({ message: 'user profile updated!' });
        });
    });
});
router.route('/api/apartments/getprofile/:userEmail')
    .get(function (req, res) {
    Apartment.find({ userEmail: req.params.userEmail }, function (err, apartment) {
        if (err)
            res.send(err);
        res.json(apartment);
    });
});
//  **The above code can be written as follows as well **
//  router.route('/api/apartments/getprofile1/:UserEmail')    
//  .get(function(req, res, next) {
//      var query = Apartment.find({}).select('.where({userEmail:req.params.UserEmail}); -_id').where({userEmail:req.params.UserEmail});
//         query.exec(function (err, Apartment) {
//      if (err) return next(err);
//      res.send(Apartment);
//  });
// })
//Business Unit Service endpoints 
router.route('/api/businessunits')
    .get(function (req, res) {
    BusinessUnit.find({ BusinessUnitName: { $exists: true } }, function (err, businessunits) {
        if (err)
            res.send(err);
        res.json(businessunits);
    });
});
router.route('/api/businessunits/butype')
    .get(function (req, res) {
    BusinessUnit.find({ unitID: { $exists: true }, UnitType: { $exists: true } }, 'unitID UnitType', { sort: { unitID: 1 } }, function (err, businessunits) {
        if (err)
            res.send(err);
        res.json(businessunits);
    });
});
// db.contest.aggregate([
//     {"$group" : {_id:"$province", count:{$sum:1}}}
// ])
router.route('/api/apartments/getstats')
    .get(function (req, res) {
    //Apartment.aggregate([{$match:{_id: "aptType"}},{$group:{_id:{aptType:"$aptType"},count:{$sum:1}}}],function(err, apartments) {
    Apartment.find('aptType', function (err, apartments) {
        if (err)
            res.send(err);
        res.json(apartments);
    });
});
router.route('/api/apartments/getdetails/:aptType/:aptStatus')
    .get(function (req, res) {
    Apartment.find({ $and: [{ aptType: req.params.aptType }, { aptStatus: req.params.aptStatus }] }, function (err, apartments) {
        if (err)
            res.send(err);
        res.json(apartments);
    });
});
/*Task Endpoints*/
router.route('/api/newtask')
    .post(function (req, res) {
    var task = new Task();
    task.taskname = req.body.taskname;
    task.taskdesc = req.body.taskdesc;
    task.assignedto = req.body.assignedto;
    task.taskstatus = 'OPEN';
    task.save(function (err) {
        if (err)
            res.send(err);
        res.json({ message: 'Task created!' });
    });
})
    .get(function (req, res) {
    Task.find(function (err, tasks) {
        if (err)
            res.send(err);
        res.json(tasks);
    });
});
router.route('/api/mytask/:userEmail')
    .get(function (req, res) {
    Task.find({ $and: [{ assignedto: req.params.userEmail.toLowerCase() }, { taskstatus: 'OPEN' }] }, function (err, task) {
        if (err)
            res.send(err);
        res.json(task);
    });
});
router.route('/api/newtask/:_id')
    .get(function (req, res) {
    Task.findById(req.params.task_id, function (err, task) {
        if (err)
            res.send(err);
        res.json(task);
    });
})
    .put(function (req, res) {
    Task.findById(req.params._id, function (err, task) {
        if (err)
            res.send(err);
        task.taskname = req.body.taskname;
        task.taskdesc = req.body.taskdesc;
        task.save(function (err) {
            if (err)
                res.send(err);
            res.json({ message: 'task updated!' });
        });
    });
})
    .delete(function (req, res) {
    Task.remove({
        _id: req.params.task_id
    }, function (err, task) {
        if (err)
            res.send(err);
        res.json({ message: 'Successfully deleted' });
    });
});
router.route('/api/mark/:_id')
    .put(function (req, res) {
    Task.findById(req.params._id, function (err, task) {
        if (err)
            res.send(err);
        task.taskstatus = 'CLOSED';
        task.save(function (err) {
            if (err)
                res.send(err);
            res.json({ message: 'task updated!' });
        });
    });
});
app.use('/', router);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsSUFBTyxPQUFPLFdBQVcsU0FBUyxDQUFDLENBQUM7QUFDcEMsSUFBTyxJQUFJLFdBQVcsTUFBTSxDQUFDLENBQUM7QUFDOUIsSUFBSSxJQUFJLEdBQVcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDO0FBQzVDLElBQUksR0FBRyxHQUFHLE9BQU8sRUFBRSxDQUFDO0FBQ3BCLElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUN4QyxJQUFJLFFBQVEsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDbkMsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBQ2pDLElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUMzQixJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUM7QUFDOUIsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBRS9CLElBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0FBQzlDLElBQUksWUFBWSxHQUFHLE9BQU8sQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO0FBQ3BELElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUVwQyxHQUFHLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNoRSxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNsRSxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7QUFDaEIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztBQUNuRCxHQUFHLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO0FBRTNCLEdBQUcsQ0FBQyxHQUFHLENBQUMsVUFBUyxHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUk7SUFDM0IsR0FBRyxDQUFDLE1BQU0sQ0FBQyw2QkFBNkIsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUMvQyxHQUFHLENBQUMsTUFBTSxDQUFDLDhCQUE4QixFQUFFLGdEQUFnRCxDQUFDLENBQUM7SUFDN0YsSUFBSSxFQUFFLENBQUM7QUFDWCxDQUFDLENBQUMsQ0FBQztBQUdILEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxFQUFDLElBQUksRUFBRSxZQUFZLEVBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLEVBQUUsVUFBUyxHQUFHLEVBQUUsR0FBRztJQUN0Riw0QkFBNEI7SUFDNUIsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0FBQzFCLENBQUMsQ0FBQyxDQUFDO0FBRUgsSUFBSSxRQUFRLEdBQ1IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZO0lBQ3hCLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVztJQUN2Qiw4RkFBOEYsQ0FBQztBQUVuRyxJQUFJLE1BQU0sR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRTtJQUMxQixJQUFJLElBQUksR0FBRyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDO0lBQ3BDLElBQUksSUFBSSxHQUFHLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUM7SUFDakMsT0FBTyxDQUFDLEdBQUcsQ0FBQyx3Q0FBd0MsR0FBRyxJQUFJLENBQUMsQ0FBQztBQUNqRSxDQUFDLENBQUMsQ0FBQztBQUVILElBQUksU0FBUyxHQUFHLEdBQUcsQ0FBQztJQUNsQixNQUFNLEVBQUUsSUFBSSxNQUFNLENBQUMsa0VBQWtFLEVBQUUsUUFBUSxDQUFDO0lBQ2hHLFFBQVEsRUFBRSxrQ0FBa0M7Q0FDN0MsQ0FBQyxDQUFDO0FBRUgsUUFBUSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsVUFBVSxHQUFHLEVBQUUsR0FBRztJQUN2QyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ1YsT0FBTyxDQUFDLEdBQUcsQ0FBRSx1QkFBdUIsR0FBRyxRQUFRLEdBQUcsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDO0lBQzlELENBQUM7SUFBQyxJQUFJLENBQUMsQ0FBQztRQUNSLE9BQU8sQ0FBQyxHQUFHLENBQUUsNkJBQTZCLEdBQUcsUUFBUSxDQUFDLENBQUM7SUFDdkQsQ0FBQztJQUFBLENBQUM7QUFDUixDQUFDLENBQUMsQ0FBQztBQUlILE1BQU0sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLFVBQVMsR0FBRyxFQUFFLEdBQUc7SUFDbkMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDO0FBQ3ZELENBQUMsQ0FBQyxDQUFDO0FBRUgsTUFBTSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUMsU0FBUyxFQUFFLFVBQVMsR0FBRyxFQUFFLEdBQUc7SUFDM0MsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSw2QkFBNkIsRUFBRSxDQUFDLENBQUM7QUFDeEQsQ0FBQyxDQUFDLENBQUM7QUFFRCxNQUFNLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQztLQUMxQixHQUFHLENBQUMsVUFBUyxHQUFHLEVBQUUsR0FBRztJQUNsQixTQUFTLENBQUMsSUFBSSxDQUFDLEVBQUMsU0FBUyxFQUFFLEVBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFDLEVBQUMsRUFBQyxXQUFXLEVBQUUsVUFBUyxHQUFHLEVBQUUsVUFBVTtRQUN4RixFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUM7WUFDSixHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2xCLEdBQUcsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7SUFFekIsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUMsQ0FBQTtBQUVGLE1BQU0sQ0FBQyxLQUFLLENBQUMsb0NBQW9DLENBQUM7S0FDakQsR0FBRyxDQUFDLFVBQVMsR0FBRyxFQUFFLEdBQUc7SUFDbEIsU0FBUyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxVQUFTLEdBQUcsRUFBRSxTQUFTO1FBQ3RELEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQztZQUNSLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDZCxTQUFTLENBQUMsYUFBYSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDO1FBQ2pELFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBUyxHQUFHO1lBQ3ZCLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQztnQkFDSixHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2xCLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsQ0FBQyxDQUFDO1FBQ25ELENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUMsQ0FBQTtBQUVGLE1BQU0sQ0FBQyxLQUFLLENBQUMsdUNBQXVDLENBQUM7S0FDcEQsR0FBRyxDQUFDLFVBQVMsR0FBRyxFQUFFLEdBQUc7SUFDbEIsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFDLFNBQVMsRUFBQyxHQUFHLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBQyxFQUFDLFVBQVMsR0FBRyxFQUFFLFNBQVM7UUFDbkUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDO1lBQ0osR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNsQixHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3hCLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDLENBQUE7QUFFSCx5REFBeUQ7QUFDekQsOERBQThEO0FBQzlELG1DQUFtQztBQUNuQyx3SUFBd0k7QUFDeEksaURBQWlEO0FBQ2pELGtDQUFrQztBQUNsQyw0QkFBNEI7QUFDNUIsT0FBTztBQUNQLEtBQUs7QUFFTCxrQ0FBa0M7QUFDakMsTUFBTSxDQUFDLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQztLQUNqQyxHQUFHLENBQUMsVUFBUyxHQUFHLEVBQUUsR0FBRztJQUNsQixZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUMsZ0JBQWdCLEVBQUUsRUFBQyxPQUFPLEVBQUUsSUFBSSxFQUFDLEVBQUMsRUFBQyxVQUFTLEdBQUcsRUFBRSxhQUFhO1FBQzdFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQztZQUNKLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFbEIsR0FBRyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUM1QixDQUFDLENBQUMsQ0FBQztBQUNULENBQUMsQ0FBQyxDQUFDO0FBRUQsTUFBTSxDQUFDLEtBQUssQ0FBQywyQkFBMkIsQ0FBQztLQUN4QyxHQUFHLENBQUMsVUFBUyxHQUFHLEVBQUUsR0FBRztJQUNsQixZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUMsTUFBTSxFQUFFLEVBQUMsT0FBTyxFQUFFLElBQUksRUFBQyxFQUFFLFFBQVEsRUFBRSxFQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUMsRUFBQyxFQUFDLGlCQUFpQixFQUFDLEVBQUMsSUFBSSxFQUFDLEVBQUMsTUFBTSxFQUFFLENBQUMsRUFBQyxFQUFDLEVBQUMsVUFBUyxHQUFHLEVBQUUsYUFBYTtRQUNuSSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUM7WUFDSixHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRWxCLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDM0IsQ0FBQyxDQUFDLENBQUM7QUFDVCxDQUFDLENBQUMsQ0FBQztBQUVGLHlCQUF5QjtBQUM3QixxREFBcUQ7QUFDckQsS0FBSztBQUVELE1BQU0sQ0FBQyxLQUFLLENBQUMsMEJBQTBCLENBQUM7S0FDdkMsR0FBRyxDQUFDLFVBQVMsR0FBRyxFQUFFLEdBQUc7SUFDbEIsZ0lBQWdJO0lBQzlILFNBQVMsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFDLFVBQVMsR0FBRyxFQUFFLFVBQVU7UUFDL0MsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDO1lBQ0osR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNsQixHQUFHLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ3hCLENBQUMsQ0FBQyxDQUFDO0FBQ1QsQ0FBQyxDQUFDLENBQUM7QUFFSCxNQUFNLENBQUMsS0FBSyxDQUFDLGdEQUFnRCxDQUFDO0tBQzVELEdBQUcsQ0FBQyxVQUFTLEdBQUcsRUFBRSxHQUFHO0lBQ2hCLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBQyxJQUFJLEVBQUMsQ0FBQyxFQUFDLE9BQU8sRUFBQyxHQUFHLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBQyxFQUFDLEVBQUMsU0FBUyxFQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFDLENBQUMsRUFBQyxFQUFFLFVBQVMsR0FBRyxFQUFFLFVBQVU7UUFDN0csRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDO1lBQ0osR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNsQixHQUFHLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ3hCLENBQUMsQ0FBQyxDQUFDO0FBQ1QsQ0FBQyxDQUFDLENBQUM7QUFHSixrQkFBa0I7QUFFbEIsTUFBTSxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUM7S0FDekIsSUFBSSxDQUFDLFVBQVMsR0FBRyxFQUFFLEdBQUc7SUFDbkIsSUFBSSxJQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUN0QixJQUFJLENBQUMsUUFBUSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDO0lBQ2xDLElBQUksQ0FBQyxRQUFRLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDbEMsSUFBSSxDQUFDLFVBQVUsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztJQUN0QyxJQUFJLENBQUMsVUFBVSxHQUFHLE1BQU0sQ0FBQztJQUN6QixJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVMsR0FBRztRQUNsQixFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUM7WUFDSixHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2xCLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsZUFBZSxFQUFFLENBQUMsQ0FBQztJQUMzQyxDQUFDLENBQUMsQ0FBQztBQUNULENBQUMsQ0FBQztLQUNDLEdBQUcsQ0FBQyxVQUFTLEdBQUcsRUFBRSxHQUFHO0lBQ2xCLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBUyxHQUFHLEVBQUUsS0FBSztRQUN6QixFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUM7WUFDSixHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRWxCLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDcEIsQ0FBQyxDQUFDLENBQUM7QUFDVCxDQUFDLENBQUMsQ0FBQztBQUVILE1BQU0sQ0FBQyxLQUFLLENBQUMsd0JBQXdCLENBQUM7S0FDbkMsR0FBRyxDQUFDLFVBQVMsR0FBRyxFQUFFLEdBQUc7SUFDbEIsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFDLElBQUksRUFBQyxDQUFDLEVBQUMsVUFBVSxFQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRSxFQUFDLEVBQUMsRUFBQyxVQUFVLEVBQUMsTUFBTSxFQUFDLENBQUMsRUFBQyxFQUFFLFVBQVMsR0FBRyxFQUFFLElBQUk7UUFDdEcsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDO1lBQ0osR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNsQixHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ25CLENBQUMsQ0FBQyxDQUFDO0FBQ1QsQ0FBQyxDQUFDLENBQUE7QUFFRixNQUFNLENBQUMsS0FBSyxDQUFDLG1CQUFtQixDQUFDO0tBQzlCLEdBQUcsQ0FBQyxVQUFTLEdBQUcsRUFBRSxHQUFHO0lBQ2xCLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsVUFBUyxHQUFHLEVBQUUsSUFBSTtRQUNoRCxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUM7WUFDSixHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2xCLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbkIsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUM7S0FFRCxHQUFHLENBQUMsVUFBUyxHQUFHLEVBQUUsR0FBRztJQUNsQixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLFVBQVMsR0FBRyxFQUFFLElBQUk7UUFDNUMsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDO1lBQ0osR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNsQixJQUFJLENBQUMsUUFBUSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBQ2xDLElBQUksQ0FBQyxRQUFRLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDbEMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFTLEdBQUc7WUFDbEIsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDO2dCQUNKLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDbEIsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxlQUFlLEVBQUUsQ0FBQyxDQUFDO1FBQzNDLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUM7S0FFRCxNQUFNLENBQUMsVUFBUyxHQUFHLEVBQUUsR0FBRztJQUNyQixJQUFJLENBQUMsTUFBTSxDQUFDO1FBQ1IsR0FBRyxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsT0FBTztLQUMxQixFQUFFLFVBQVMsR0FBRyxFQUFFLElBQUk7UUFDakIsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDO1lBQ0osR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUVsQixHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxFQUFFLHNCQUFzQixFQUFFLENBQUMsQ0FBQztJQUNsRCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQyxDQUFDO0FBRUgsTUFBTSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQztLQUM3QixHQUFHLENBQUMsVUFBUyxHQUFHLEVBQUUsR0FBRztJQUNsQixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLFVBQVMsR0FBRyxFQUFFLElBQUk7UUFDNUMsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDO1lBQ0osR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNsQixJQUFJLENBQUMsVUFBVSxHQUFHLFFBQVEsQ0FBQztRQUMzQixJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVMsR0FBRztZQUNsQixFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUM7Z0JBQ0osR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNsQixHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxFQUFFLGVBQWUsRUFBRSxDQUFDLENBQUM7UUFDM0MsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQyxDQUFBO0FBRU4sR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUMiLCJmaWxlIjoic2VydmVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGV4cHJlc3MgPSByZXF1aXJlKCdleHByZXNzJyk7XHJcbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xyXG52YXIgcG9ydDogbnVtYmVyID0gcHJvY2Vzcy5lbnYuUE9SVCB8fCAzMDAwO1xyXG52YXIgYXBwID0gZXhwcmVzcygpO1xyXG52YXIgYm9keVBhcnNlciA9IHJlcXVpcmUoJ2JvZHktcGFyc2VyJyk7XHJcbnZhciBtb25nb29zZSA9IHJlcXVpcmUoJ21vbmdvb3NlJyk7XHJcbnZhciBqd3QgPSByZXF1aXJlKCdleHByZXNzLWp3dCcpO1xyXG52YXIgY29ycyA9IHJlcXVpcmUoJ2NvcnMnKTtcclxudmFyIHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XHJcbnZhciBtdWx0ZXIgPSByZXF1aXJlKFwibXVsdGVyXCIpO1xyXG5cclxudmFyIEFwYXJ0bWVudCA9IHJlcXVpcmUoJy4vbW9kZWxzL2FwYXJ0bWVudCcpO1xyXG52YXIgQnVzaW5lc3NVbml0ID0gcmVxdWlyZSgnLi9tb2RlbHMvYnVzaW5lc3N1bml0Jyk7IFxyXG52YXIgVGFzayA9IHJlcXVpcmUoJy4vbW9kZWxzL3Rhc2snKTtcclxuXHJcbmFwcC51c2UoJy9hcHAnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnYXBwJykpKTtcclxuYXBwLnVzZSgnL2xpYnMnLCBleHByZXNzLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnbGlicycpKSk7XHJcbmFwcC51c2UoY29ycygpKTtcclxuYXBwLnVzZShib2R5UGFyc2VyLnVybGVuY29kZWQoeyBleHRlbmRlZDogdHJ1ZSB9KSk7XHJcbmFwcC51c2UoYm9keVBhcnNlci5qc29uKCkpO1xyXG5cclxuYXBwLnVzZShmdW5jdGlvbihyZXEsIHJlcywgbmV4dCkge1xyXG4gICAgcmVzLmhlYWRlcihcIkFjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpblwiLCBcIipcIik7XHJcbiAgICByZXMuaGVhZGVyKFwiQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVyc1wiLCBcIk9yaWdpbiwgWC1SZXF1ZXN0ZWQtV2l0aCwgQ29udGVudC1UeXBlLCBBY2NlcHRcIik7XHJcbiAgICBuZXh0KCk7XHJcbn0pO1xyXG5cclxuXHJcbmFwcC5wb3N0KFwiL3VwbG9hZFwiLCBtdWx0ZXIoe2Rlc3Q6IFwiLi91cGxvYWRzL1wifSkuYXJyYXkoXCJ1cGxvYWRzW11cIiwgMTIpLCBmdW5jdGlvbihyZXEsIHJlcykge1xyXG4gICAgLy8ocmVzLnNlbmQocmVxWydmaWxlcyddKSk7IFxyXG4gICAgKHJlcy5zZW5kKHJlcS5maWxlcykpOyBcclxufSk7XHJcblxyXG52YXIgZGJzdHJpbmcgPVxyXG4gICAgcHJvY2Vzcy5lbnYuTU9OR09MQUJfVVJJIHx8XHJcbiAgICBwcm9jZXNzLmVudi5NT05HT0hRX1VSTCB8fFxyXG4gICAgJ21vbmdvZGI6Ly9oZXJva3VfZDRuNmhuaGw6cTRyZmMxdWlrZDUxZDVzdXBzOW1pcGl2bmxAZHMwNTcyNTQubWxhYi5jb206NTcyNTQvaGVyb2t1X2Q0bjZobmhsJztcclxuXHJcbnZhciBzZXJ2ZXIgPSBhcHAubGlzdGVuKHBvcnQsIGZ1bmN0aW9uKCkge1xyXG4gICAgdmFyIGhvc3QgPSBzZXJ2ZXIuYWRkcmVzcygpLmFkZHJlc3M7XHJcbiAgICB2YXIgcG9ydCA9IHNlcnZlci5hZGRyZXNzKCkucG9ydDtcclxuICAgIGNvbnNvbGUubG9nKCdUaGlzIGV4cHJlc3MgYXBwIGlzIGxpc3RlbmluZyBvbiBwb3J0OicgKyBwb3J0KTtcclxufSk7XHJcblxyXG52YXIgYXV0aENoZWNrID0gand0KHtcclxuICBzZWNyZXQ6IG5ldyBCdWZmZXIoJzQ2MERQWTdQaTR4blJVaWlyUHVFZkJkeFM0d3pRR2N4OHJsQS1Rdzc2ZlVSa21pd3RyaHZfSVhmZnpzSTg0SE0nLCAnYmFzZTY0JyksXHJcbiAgYXVkaWVuY2U6ICcxbXZIR3lrVkh2eHpwd3N0cDJ3VG1yekxycHpvdVZUbSdcclxufSk7XHJcblxyXG5tb25nb29zZS5jb25uZWN0KGRic3RyaW5nLCBmdW5jdGlvbiAoZXJyLCByZXMpIHtcclxuICAgICAgaWYgKGVycikge1xyXG4gICAgICBjb25zb2xlLmxvZyAoJ0VSUk9SIGNvbm5lY3RpbmcgdG86ICcgKyBkYnN0cmluZyArICcuICcgKyBlcnIpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zb2xlLmxvZyAoJ1N1Y2Nlc3NmdWxseSBjb25uZWN0ZWQgdG86ICcgKyBkYnN0cmluZyk7XHJcbiAgICAgIH07XHJcbn0pO1xyXG5cclxuXHJcblxyXG5yb3V0ZXIuZ2V0KCcvYXBwLyonLCBmdW5jdGlvbihyZXEsIHJlcykge1xyXG4gICByZXMuc2VuZEZpbGUocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJ2luZGV4Lmh0bWwnKSk7XHJcbn0pO1xyXG5cclxucm91dGVyLmdldCgnL2FwaScsYXV0aENoZWNrLCBmdW5jdGlvbihyZXEsIHJlcykge1xyXG4gICByZXMuanNvbih7IG1lc3NhZ2U6ICdob29yYXkhIHdlbGNvbWUgdG8gb3VyIGFwaSEnIH0pO1xyXG59KTtcclxuXHJcbiAgcm91dGVyLnJvdXRlKCcvYXBpL2dldHVzZXJzJykgICAgXHJcbiAgICAuZ2V0KGZ1bmN0aW9uKHJlcSwgcmVzKSB7ICAgICAgICBcclxuICAgICAgICBBcGFydG1lbnQuZmluZCh7dXNlckVtYWlsOiB7JGV4aXN0czogdHJ1ZSwgJG5lOiBudWxsfX0sJ3VzZXJFbWFpbCcsIGZ1bmN0aW9uKGVyciwgYXBhcnRtZW50cykge1xyXG4gICAgICAgICAgICBpZiAoZXJyKVxyXG4gICAgICAgICAgICAgICAgcmVzLnNlbmQoZXJyKTtcclxuICAgICAgICAgICAgcmVzLmpzb24oYXBhcnRtZW50cyk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgIH0pO1xyXG4gICAgfSlcclxuXHJcbiAgICByb3V0ZXIucm91dGUoJy9hcGkvYXBhcnRtZW50cy91cGRhdGVwcm9maWxlLzpfaWQnKSAgICBcclxuICAgIC5wdXQoZnVuY3Rpb24ocmVxLCByZXMpIHtcclxuICAgICAgICBBcGFydG1lbnQuZmluZEJ5SWQocmVxLnBhcmFtcy5faWQsIGZ1bmN0aW9uKGVyciwgYXBhcnRtZW50KSB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpXHJcbiAgICAgICAgICAgIHJlcy5zZW5kKGVycik7XHJcbiAgICAgICAgICAgIGFwYXJ0bWVudC51c2VyRmlyc3ROYW1lID0gcmVxLmJvZHkudXNlckZpcnN0TmFtZTsgIFxyXG4gICAgICAgICAgICBhcGFydG1lbnQuc2F2ZShmdW5jdGlvbihlcnIpIHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzLnNlbmQoZXJyKTtcclxuICAgICAgICAgICAgICAgIHJlcy5qc29uKHsgbWVzc2FnZTogJ3VzZXIgcHJvZmlsZSB1cGRhdGVkIScgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSlcclxuICBcclxuICAgIHJvdXRlci5yb3V0ZSgnL2FwaS9hcGFydG1lbnRzL2dldHByb2ZpbGUvOnVzZXJFbWFpbCcpICAgIFxyXG4gICAgLmdldChmdW5jdGlvbihyZXEsIHJlcykge1xyXG4gICAgICAgIEFwYXJ0bWVudC5maW5kKHt1c2VyRW1haWw6cmVxLnBhcmFtcy51c2VyRW1haWx9LGZ1bmN0aW9uKGVyciwgYXBhcnRtZW50KSB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpXHJcbiAgICAgICAgICAgICAgICByZXMuc2VuZChlcnIpO1xyXG4gICAgICAgICAgICByZXMuanNvbihhcGFydG1lbnQpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSlcclxuXHJcbiAgIC8vICAqKlRoZSBhYm92ZSBjb2RlIGNhbiBiZSB3cml0dGVuIGFzIGZvbGxvd3MgYXMgd2VsbCAqKlxyXG4gICAvLyAgcm91dGVyLnJvdXRlKCcvYXBpL2FwYXJ0bWVudHMvZ2V0cHJvZmlsZTEvOlVzZXJFbWFpbCcpICAgIFxyXG4gICAvLyAgLmdldChmdW5jdGlvbihyZXEsIHJlcywgbmV4dCkge1xyXG4gICAvLyAgICAgIHZhciBxdWVyeSA9IEFwYXJ0bWVudC5maW5kKHt9KS5zZWxlY3QoJy53aGVyZSh7dXNlckVtYWlsOnJlcS5wYXJhbXMuVXNlckVtYWlsfSk7IC1faWQnKS53aGVyZSh7dXNlckVtYWlsOnJlcS5wYXJhbXMuVXNlckVtYWlsfSk7XHJcbiAgIC8vICAgICAgICAgcXVlcnkuZXhlYyhmdW5jdGlvbiAoZXJyLCBBcGFydG1lbnQpIHtcclxuICAgLy8gICAgICBpZiAoZXJyKSByZXR1cm4gbmV4dChlcnIpO1xyXG4gICAvLyAgICAgIHJlcy5zZW5kKEFwYXJ0bWVudCk7XHJcbiAgIC8vICB9KTtcclxuICAgLy8gfSlcclxuICAgIFxyXG4gICAvL0J1c2luZXNzIFVuaXQgU2VydmljZSBlbmRwb2ludHMgXHJcbiAgICByb3V0ZXIucm91dGUoJy9hcGkvYnVzaW5lc3N1bml0cycpICAgICAgICAgICAgIFxyXG4gICAgLmdldChmdW5jdGlvbihyZXEsIHJlcykge1xyXG4gICAgICAgIEJ1c2luZXNzVW5pdC5maW5kKHtCdXNpbmVzc1VuaXROYW1lOiB7JGV4aXN0czogdHJ1ZX19LGZ1bmN0aW9uKGVyciwgYnVzaW5lc3N1bml0cykge1xyXG4gICAgICAgICAgICBpZiAoZXJyKVxyXG4gICAgICAgICAgICAgICAgcmVzLnNlbmQoZXJyKTtcclxuXHJcbiAgICAgICAgICAgIHJlcy5qc29uKGJ1c2luZXNzdW5pdHMpO1xyXG4gICAgICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICAgIHJvdXRlci5yb3V0ZSgnL2FwaS9idXNpbmVzc3VuaXRzL2J1dHlwZScpICAgICAgICAgICAgIFxyXG4gICAgLmdldChmdW5jdGlvbihyZXEsIHJlcykge1xyXG4gICAgICAgIEJ1c2luZXNzVW5pdC5maW5kKHt1bml0SUQ6IHskZXhpc3RzOiB0cnVlfSwgVW5pdFR5cGU6IHskZXhpc3RzOiB0cnVlfX0sJ3VuaXRJRCBVbml0VHlwZScse3NvcnQ6e3VuaXRJRDogMX19LGZ1bmN0aW9uKGVyciwgYnVzaW5lc3N1bml0cykge1xyXG4gICAgICAgICAgICBpZiAoZXJyKVxyXG4gICAgICAgICAgICAgICAgcmVzLnNlbmQoZXJyKTtcclxuXHJcbiAgICAgICAgICAgIHJlcy5qc29uKGJ1c2luZXNzdW5pdHMpO1xyXG4gICAgICAgICB9KTtcclxuICAgfSk7ICAgXHJcblxyXG4gICAgLy8gZGIuY29udGVzdC5hZ2dyZWdhdGUoW1xyXG4vLyAgICAge1wiJGdyb3VwXCIgOiB7X2lkOlwiJHByb3ZpbmNlXCIsIGNvdW50Onskc3VtOjF9fX1cclxuLy8gXSlcclxuXHJcbiAgICByb3V0ZXIucm91dGUoJy9hcGkvYXBhcnRtZW50cy9nZXRzdGF0cycpICAgICAgICAgICAgIFxyXG4gICAgLmdldChmdW5jdGlvbihyZXEsIHJlcykge1xyXG4gICAgICAgIC8vQXBhcnRtZW50LmFnZ3JlZ2F0ZShbeyRtYXRjaDp7X2lkOiBcImFwdFR5cGVcIn19LHskZ3JvdXA6e19pZDp7YXB0VHlwZTpcIiRhcHRUeXBlXCJ9LGNvdW50Onskc3VtOjF9fX1dLGZ1bmN0aW9uKGVyciwgYXBhcnRtZW50cykge1xyXG4gICAgICAgICAgQXBhcnRtZW50LmZpbmQoJ2FwdFR5cGUnLGZ1bmN0aW9uKGVyciwgYXBhcnRtZW50cykge1xyXG4gICAgICAgICAgICBpZiAoZXJyKVxyXG4gICAgICAgICAgICAgICAgcmVzLnNlbmQoZXJyKTtcclxuICAgICAgICAgICAgcmVzLmpzb24oYXBhcnRtZW50cyk7XHJcbiAgICAgICAgIH0pO1xyXG4gICB9KTsgICAgICAgXHJcbiBcclxuICAgcm91dGVyLnJvdXRlKCcvYXBpL2FwYXJ0bWVudHMvZ2V0ZGV0YWlscy86YXB0VHlwZS86YXB0U3RhdHVzJykgICAgICAgICAgICAgXHJcbiAgICAuZ2V0KGZ1bmN0aW9uKHJlcSwgcmVzKSB7ICAgICAgICBcclxuICAgICAgICAgIEFwYXJ0bWVudC5maW5kKHskYW5kOlt7YXB0VHlwZTpyZXEucGFyYW1zLmFwdFR5cGV9LHthcHRTdGF0dXM6cmVxLnBhcmFtcy5hcHRTdGF0dXN9XX0sIGZ1bmN0aW9uKGVyciwgYXBhcnRtZW50cykge1xyXG4gICAgICAgICAgICBpZiAoZXJyKVxyXG4gICAgICAgICAgICAgICAgcmVzLnNlbmQoZXJyKTtcclxuICAgICAgICAgICAgcmVzLmpzb24oYXBhcnRtZW50cyk7XHJcbiAgICAgICAgIH0pO1xyXG4gICB9KTsgICAgICAgXHJcblxyXG5cclxuICAvKlRhc2sgRW5kcG9pbnRzKi9cclxuXHJcbiAgcm91dGVyLnJvdXRlKCcvYXBpL25ld3Rhc2snKVxyXG4gICAgLnBvc3QoZnVuY3Rpb24ocmVxLCByZXMpIHsgICAgICAgIFxyXG4gICAgICAgIHZhciB0YXNrID0gbmV3IFRhc2soKTtcclxuICAgICAgICB0YXNrLnRhc2tuYW1lID0gcmVxLmJvZHkudGFza25hbWU7XHJcbiAgICAgICAgdGFzay50YXNrZGVzYyA9IHJlcS5ib2R5LnRhc2tkZXNjO1xyXG4gICAgICAgIHRhc2suYXNzaWduZWR0byA9IHJlcS5ib2R5LmFzc2lnbmVkdG87XHJcbiAgICAgICAgdGFzay50YXNrc3RhdHVzID0gJ09QRU4nO1xyXG4gICAgICAgIHRhc2suc2F2ZShmdW5jdGlvbihlcnIpIHtcclxuICAgICAgICAgICAgaWYgKGVycilcclxuICAgICAgICAgICAgICAgIHJlcy5zZW5kKGVycik7XHJcbiAgICAgICAgICAgIHJlcy5qc29uKHsgbWVzc2FnZTogJ1Rhc2sgY3JlYXRlZCEnIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gIH0pXHJcbiAgICAuZ2V0KGZ1bmN0aW9uKHJlcSwgcmVzKSB7XHJcbiAgICAgICAgVGFzay5maW5kKGZ1bmN0aW9uKGVyciwgdGFza3MpIHtcclxuICAgICAgICAgICAgaWYgKGVycilcclxuICAgICAgICAgICAgICAgIHJlcy5zZW5kKGVycik7XHJcblxyXG4gICAgICAgICAgICByZXMuanNvbih0YXNrcyk7XHJcbiAgICAgICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIHJvdXRlci5yb3V0ZSgnL2FwaS9teXRhc2svOnVzZXJFbWFpbCcpICAgIFxyXG4gICAgLmdldChmdW5jdGlvbihyZXEsIHJlcykge1xyXG4gICAgICAgIFRhc2suZmluZCh7JGFuZDpbe2Fzc2lnbmVkdG86cmVxLnBhcmFtcy51c2VyRW1haWwudG9Mb3dlckNhc2UoKX0se3Rhc2tzdGF0dXM6J09QRU4nfV19LCBmdW5jdGlvbihlcnIsIHRhc2spIHtcclxuICAgICAgICAgICAgaWYgKGVycilcclxuICAgICAgICAgICAgICAgIHJlcy5zZW5kKGVycik7XHJcbiAgICAgICAgICAgIHJlcy5qc29uKHRhc2spO1xyXG4gICAgICAgIH0pO1xyXG4gIH0pICBcclxuICBcclxuICByb3V0ZXIucm91dGUoJy9hcGkvbmV3dGFzay86X2lkJykgICAgXHJcbiAgICAuZ2V0KGZ1bmN0aW9uKHJlcSwgcmVzKSB7XHJcbiAgICAgICAgVGFzay5maW5kQnlJZChyZXEucGFyYW1zLnRhc2tfaWQsIGZ1bmN0aW9uKGVyciwgdGFzaykge1xyXG4gICAgICAgICAgICBpZiAoZXJyKVxyXG4gICAgICAgICAgICAgICAgcmVzLnNlbmQoZXJyKTtcclxuICAgICAgICAgICAgcmVzLmpzb24odGFzayk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KVxyXG5cclxuICAgIC5wdXQoZnVuY3Rpb24ocmVxLCByZXMpIHtcclxuICAgICAgICBUYXNrLmZpbmRCeUlkKHJlcS5wYXJhbXMuX2lkLCBmdW5jdGlvbihlcnIsIHRhc2spIHtcclxuICAgICAgICAgICAgaWYgKGVycilcclxuICAgICAgICAgICAgICAgIHJlcy5zZW5kKGVycik7XHJcbiAgICAgICAgICAgIHRhc2sudGFza25hbWUgPSByZXEuYm9keS50YXNrbmFtZTsgIFxyXG4gICAgICAgICAgICB0YXNrLnRhc2tkZXNjID0gcmVxLmJvZHkudGFza2Rlc2M7XHJcbiAgICAgICAgICAgIHRhc2suc2F2ZShmdW5jdGlvbihlcnIpIHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzLnNlbmQoZXJyKTtcclxuICAgICAgICAgICAgICAgIHJlcy5qc29uKHsgbWVzc2FnZTogJ3Rhc2sgdXBkYXRlZCEnIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH0pXHJcblxyXG4gICAgLmRlbGV0ZShmdW5jdGlvbihyZXEsIHJlcykge1xyXG4gICAgICAgIFRhc2sucmVtb3ZlKHtcclxuICAgICAgICAgICAgX2lkOiByZXEucGFyYW1zLnRhc2tfaWRcclxuICAgICAgICB9LCBmdW5jdGlvbihlcnIsIHRhc2spIHtcclxuICAgICAgICAgICAgaWYgKGVycilcclxuICAgICAgICAgICAgICAgIHJlcy5zZW5kKGVycik7XHJcblxyXG4gICAgICAgICAgICByZXMuanNvbih7IG1lc3NhZ2U6ICdTdWNjZXNzZnVsbHkgZGVsZXRlZCcgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICByb3V0ZXIucm91dGUoJy9hcGkvbWFyay86X2lkJykgIFxyXG4gICAgLnB1dChmdW5jdGlvbihyZXEsIHJlcykge1xyXG4gICAgICAgIFRhc2suZmluZEJ5SWQocmVxLnBhcmFtcy5faWQsIGZ1bmN0aW9uKGVyciwgdGFzaykge1xyXG4gICAgICAgICAgICBpZiAoZXJyKVxyXG4gICAgICAgICAgICAgICAgcmVzLnNlbmQoZXJyKTtcclxuICAgICAgICAgICAgdGFzay50YXNrc3RhdHVzID0gJ0NMT1NFRCc7ICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgdGFzay5zYXZlKGZ1bmN0aW9uKGVycikge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycilcclxuICAgICAgICAgICAgICAgICAgICByZXMuc2VuZChlcnIpO1xyXG4gICAgICAgICAgICAgICAgcmVzLmpzb24oeyBtZXNzYWdlOiAndGFzayB1cGRhdGVkIScgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSkgIFxyXG5cclxuYXBwLnVzZSgnLycsIHJvdXRlcik7Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
